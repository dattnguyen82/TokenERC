<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sample Token WebApp</title>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="https://cdn.rawgit.com/ethereumjs/browser-builds/2fb69a714afe092b06645286f14b94f41e5c062c/dist/ethereumjs-tx.js"></script>

    <script>
        let accounts = ['0x002B7191D4a9dA9323374A95E515075c59087d92','0x002C2501052Be4a643c7F48Fa5Ee397fb7240b3C'];
        let contracts = ['0x9150028D11Ed275CCA257Ef218E5aB2453542f19'];
        let token621Contract = web3.eth.contract([
            {
                "constant": true,
                "inputs": [],
                "name": "name",
                "outputs": [
                    {
                        "name": "_name",
                        "type": "string"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_spender",
                        "type": "address"
                    },
                    {
                        "name": "_value",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [
                    {
                        "name": "success",
                        "type": "bool"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_value",
                        "type": "uint256"
                    },
                    {
                        "name": "_to",
                        "type": "address"
                    }
                ],
                "name": "increaseSupply",
                "outputs": [
                    {
                        "name": "",
                        "type": "bool"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "totalSupply",
                "outputs": [
                    {
                        "name": "_totalSupply",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_from",
                        "type": "address"
                    },
                    {
                        "name": "_to",
                        "type": "address"
                    },
                    {
                        "name": "_value",
                        "type": "uint256"
                    }
                ],
                "name": "transferFrom",
                "outputs": [
                    {
                        "name": "success",
                        "type": "bool"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "balances",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [
                    {
                        "name": "_decimals",
                        "type": "uint8"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "tokenDecimals",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "tokenName",
                "outputs": [
                    {
                        "name": "",
                        "type": "string"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "_owner",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "name": "balance",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "tokenSymbol",
                "outputs": [
                    {
                        "name": "",
                        "type": "string"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_value",
                        "type": "uint256"
                    },
                    {
                        "name": "_from",
                        "type": "address"
                    }
                ],
                "name": "decreaseSupply",
                "outputs": [
                    {
                        "name": "",
                        "type": "bool"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "symbol",
                "outputs": [
                    {
                        "name": "_symbol",
                        "type": "string"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_to",
                        "type": "address"
                    },
                    {
                        "name": "_value",
                        "type": "uint256"
                    }
                ],
                "name": "transfer",
                "outputs": [
                    {
                        "name": "success",
                        "type": "bool"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "_owner",
                        "type": "address"
                    },
                    {
                        "name": "_spender",
                        "type": "address"
                    }
                ],
                "name": "allowance",
                "outputs": [
                    {
                        "name": "_remaining",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "name": "_initialAmount",
                        "type": "uint256"
                    },
                    {
                        "name": "_tokenName",
                        "type": "string"
                    },
                    {
                        "name": "_tokenSymbol",
                        "type": "string"
                    },
                    {
                        "name": "_decimalUnits",
                        "type": "uint8"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "payable": true,
                "stateMutability": "payable",
                "type": "fallback"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "name": "_from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "name": "_to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "name": "_value",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "name": "_owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "name": "_spender",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "name": "_value",
                        "type": "uint256"
                    }
                ],
                "name": "Approval",
                "type": "event"
            }
        ]);
        let token621 = token621Contract.at(contracts[0]);

        var web3;
        var txHash = '';

        window.App = {
            start: () => {
                App.getBalances();
                App.getMetaData();
                App.addEventListener();
            },
            getMetaData: () => {
                token621.totalSupply.call((err, result) => {
                    if (err)
                        console.log("err: " +  err);
                    App.updateElem("tokenSupply", result);
                });

                token621.name.call((err, result) => {
                    if (err)
                        console.log("err: " +  err);
                    App.updateElem("tokenName", result);
                });

                token621.symbol.call((err, result) => {
                    if (err)
                        console.log("err: " +  err);
                    App.updateElem("tokenSymbol", result);
                });
            },
            transfer: () => {
                web3.eth.getTransactionCount(accounts[0], (err, result) => {
                    var nonceCount = result;

                    var gasPriceGwei = 3;
                    var gasLimit = 3000000;
                    var ropstenChainId = 3;

                    var fromAddr = document.getElementById('addr1').value;
                    var toAddr = document.getElementById('addr2').value;
                    var amount = document.getElementById('amount').value;

                    var txData = token621.transfer.getData(toAddr, amount);

                    var rawTransaction = {
                            from: fromAddr,
                            nonce: '0x' + nonceCount.toString(16),
                            gasPrice: web3.toHex(gasPriceGwei),
                            gasLimit: web3.toHex(gasLimit),
                            to: contracts[0],
                            value: '0x0',
                            data: txData,
                            chainId: ropstenChainId
                    };

                    var privateKey = new EthJS.Buffer.Buffer('INSERT PRIVATE KEY HERE', 'hex');
                    var tx = new EthJS.Tx(rawTransaction);
                    tx.sign(privateKey);
                    var serializedTx = tx.serialize();

                    web3.eth.sendRawTransaction('0x' + serializedTx.toString('hex'), function(err, hash)  {
                        if (!err) {
                            console.log(hash);
                            txHash = hash;
                            alert("Transaction with hash: " + hash + " has been submitted")
                        }
                        else {
                            console.log(err);
                        }
                    });
                });
            },
            viewStatus: () => {
                var txUrl = 'https://ropsten.etherscan.io/tx/' + txHash;
                window.open(txUrl);
                return true;
            },
            getBalances: () => {
                token621.balanceOf.call(accounts[0],(err, result) => {
                    if (err)
                        console.log("err: " +  err);
                    App.updateElem("balance1", result);
                });

                token621.balanceOf.call(accounts[1],(err, result) => {
                    if (err)
                        console.log("err: " +  err);
                    App.updateElem("balance2", result);
                });
            },
            updateElem: (id, value) => {
                document.getElementById(id).value = value;
            },
            addEventListener: () => {
                var LogTransfer = token621.Transfer({},{fromBlock: 0, toBlock: 'latest'});

                LogTransfer.watch((err, result) => {
                    if(!err){
                        console.log(result)
                    }else{
                        console.log(err)
                    }
                })
            }
        };

        window.addEventListener('load', () => {
            if (typeof web3 !== 'undefined') {
                console.warn("Using web3 detected from external source. If you find that your accounts don't appear or you have 0 MetaCoin, ensure you've configured that source properly. If using MetaMask, see the following link. Feel free to delete this warning. :) http://truffleframework.com/tutorials/truffle-and-metamask")
                web3 = new Web3(web3.currentProvider);
            } else {
                console.warn("No web3 detected. Falling back to http://127.0.0.1:9545. You should remove this fallback when you deploy live, as it's inherently insecure. Consider switching to Metamask for development. More info here: http://truffleframework.com/tutorials/truffle-and-metamask");
                web3 = new Web3(new Web3.providers.HttpProvider("http://127.0.0.1:9545"));
            }

            var version = web3.version.api;

            if (version.substr(0,3) != '0.2')
                alert("The sample is designed to work with web3 version 0.2x.x, and you are on: " + version + ", things may not work correctly");

            console.log(version);

            App.start();
        });
    </script>
</head>
<body>

<table width="100%">
    <tr>
        <td colspan="4" align="center">Token Metadata</td>
    </tr>
    <tr>
        <td align="right">Token Name:</td>
        <td><input type="text" size="64" id="tokenName" readonly></td>
    </tr>
    <tr>
        <td align="right">Token Symbol:</td>
        <td><input type="text" size="64" id="tokenSymbol" readonly></td>
    </tr>
    <tr>
        <td align="right">Total Supply:</td>
        <td><input type="number" size="64" id="tokenSupply" readonly></td>
    </tr>
</table>
<hr>
<table width="100%">
    <tr>
       <td colspan="4" align="center">Transfer Tokens</td>
    </tr>
    <tr>
        <td align="right">From:</td>
        <td><input type="text" placeholder="Ethereum Address" size="48" id="addr1" value="0x002B7191D4a9dA9323374A95E515075c59087d92"></td>
        <td align="right">Balance:</td>
        <td><input type="number" size="10" id="balance1" readonly></td>
    </tr>
    <tr>
        <td align="right">To:</td>
        <td><input type="text" placeholder="Ethereum Address" size="48" id="addr2" value="0x002C2501052Be4a643c7F48Fa5Ee397fb7240b3C"></td>
        <td align="right">Balance:</td>
        <td><input type="number" size="10" id="balance2" readonly></td>
    </tr>
    <tr>
        <td align="right">Amount:</td><td colspan="3"><input type="number" id="amount" value="2"></td>
    </tr>
    <tr>
        <td align="right" colspan="4"><button id="submit" onclick="App.transfer();">submit</button></td>
    </tr>
</table>
<br>
<hr>
<div align="center">
    <button id="status" onclick="App.viewStatus();">Check transaction status</button>
</div>

</body>
</html>
